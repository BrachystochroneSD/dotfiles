#!/bin/bash

w3m="w3mimgdisplay"
read -r LINES COLUMNS < <(stty size)
MUSIC_DIR=$HOME/Music
COVER=/tmp/cover.jpg

backup(){
    backup="/home/sam/Documents/zenocyne/site_zenocyne/www/html/ressources/owl.png"
    draw_img $backup
}

draw_img() {    
    
    # Display the image.
    printf '0;1;%s;%s;%s;%s;;;;;%s\n3;\n4\n' \
           "0" \
           "0" \
           "192" \
           "192" \
           "$1" | "$w3m" &>/dev/null
}

while true;do

    album=$(mpc --format %album% current)
    file=$(mpc --format %file% current)
    album_dir="${file%/*}"
    [[ -z "$album_dir" ]] && exit 1
    album_dir="$MUSIC_DIR/$album_dir"
    covers="$(find "$album_dir" -type d -exec find {} -maxdepth 1 -type f -iregex ".*/.*\(${album}\|cover\|folder\|artwork\|front\).*[.]\(jpe?g\|png\|gif\|bmp\)" \; )"
    src="$(echo -n "$covers" | head -n1)"
    rm -f "$COVER" 
    if [[ -n "$src" ]] ; then
	#resize the image's width to 300px 
	convert "$src" -resize 300x "$COVER"
	if [[ -f "$COVER" ]] ; then
	    draw_img $COVER
	else
	    backup
	fi
    else
	backup
    fi
    sleep 0.5
done
